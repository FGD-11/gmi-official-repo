<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="tailwind/index.css">
  <title>Verifikasi Email</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col justify-center items-center px-4 py-10">
  <div class="bg-white shadow-md rounded-lg max-w-md w-full p-8">
    <h2 class="text-2xl font-semibold text-center mb-4 text-gray-800">Verifikasi Email Anda</h2>
    <p class="text-center text-gray-600 mb-8">Kami telah mengirim kode OTP ke email Anda. Silakan masukkan kode di bawah ini:</p>

    <input
      type="text"
      id="otpInput"
      placeholder="Masukkan OTP"
      maxlength="6"
      class="w-full border border-gray-300 rounded-md px-4 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center tracking-widest"
      inputmode="numeric"
      pattern="[0-9]*"
      autocomplete="one-time-code"
      aria-label="Masukkan kode OTP 6 digit"
    />
    <button
      onclick="verifikasiOTP()"
      class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-md transition-colors duration-300 flex justify-center items-center gap-2"
      aria-label="Tombol verifikasi OTP"
    >
      <i class="fas fa-check-circle"></i> Verifikasi
    </button>

    <p id="status" class="mt-6 text-center text-sm text-red-600 min-h-[1.5rem]"></p>
  </div>

  <script>
    // Konfigurasi Firebase kamu
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDCt1DuzTaHaVekghka98_rAO6tU8iLhKQ",
  authDomain: "gmi-enterprise080625.firebaseapp.com",
  projectId: "gmi-enterprise080625",
  storageBucket: "gmi-enterprise080625.firebasestorage.app",
  messagingSenderId: "740806922771",
  appId: "1:740806922771:web:7245637b3bf1d916a925e6",
  measurementId: "G-5ZZZMH79V9"
};
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let generatedOTP = null;

    // Fungsi untuk membuat OTP 6 digit
    function generateOTP() {
      return Math.floor(100000 + Math.random() * 900000).toString();
    }

    // Fungsi kirim OTP ke backend
    async function kirimOTP(email, otp) {
      try {
        const response = await fetch("https://d665d6d6-10ae-4e18-a0e0-c799e350cd84-00-2nmcxgte4bnv6.sisko.replit.dev/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ email, code: otp })
        });
        return response.ok;
      } catch (error) {
        return false;
      }
    }

    // Saat halaman dimuat
    window.onload = async () => {
      auth.onAuthStateChanged(async (user) => {
        if (user && user.email) {
          generatedOTP = generateOTP();
          const sent = await kirimOTP(user.email, generatedOTP);

          if (sent) {
            document.getElementById("status").textContent = "OTP telah dikirim ke: " + user.email;
            document.getElementById("status").classList.remove("text-red-600");
            document.getElementById("status").classList.add("text-green-600");
          } else {
            document.getElementById("status").textContent = "Gagal mengirim OTP.";
            document.getElementById("status").classList.remove("text-green-600");
            document.getElementById("status").classList.add("text-red-600");
          }
        } else {
          document.getElementById("status").textContent = "Tidak ada pengguna terautentikasi.";
          document.getElementById("status").classList.remove("text-green-600");
          document.getElementById("status").classList.add("text-red-600");
        }
      });
    };

    // Verifikasi OTP
    async function verifikasiOTP() {
      const inputOTP = document.getElementById("otpInput").value.trim();
      if (inputOTP.length !== 6 || !/^\d{6}$/.test(inputOTP)) {
        document.getElementById("status").textContent = "Masukkan kode OTP 6 digit yang valid.";
        document.getElementById("status").classList.remove("text-green-600");
        document.getElementById("status").classList.add("text-red-600");
        return;
      }
      if (inputOTP === generatedOTP) {
        const user = auth.currentUser;
        if (user) {
          try {
            await db.collection("verifikasi").doc(user.uid).set({
              gmail: true,
              timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            window.location.href = "index.html";
          } catch (error) {
            document.getElementById("status").textContent = "Terjadi kesalahan saat menyimpan data verifikasi.";
            document.getElementById("status").classList.remove("text-green-600");
            document.getElementById("status").classList.add("text-red-600");
          }
        } else {
          document.getElementById("status").textContent = "Pengguna tidak ditemukan. Silakan login ulang.";
          document.getElementById("status").classList.remove("text-green-600");
          document.getElementById("status").classList.add("text-red-600");
        }
      } else {
        document.getElementById("status").textContent = "OTP salah. Silakan coba lagi.";
        document.getElementById("status").classList.remove("text-green-600");
        document.getElementById("status").classList.add("text-red-600");
      }
    }
  </script>
</body>
</html>